apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-config
  namespace: atlas
data:
  kong.yml: |
    _format_version: "2.1"
    _transform: true

    services:
      # Core Service - Always available
      - name: core-service
        url: http://atlas-core.atlas.svc.cluster.local:8000
        routes:
          - name: core-routes
            paths:
              - /api/auth
              - /api/users
              - /api/tenants
              - /api/subscriptions
            strip_path: true
            preserve_host: true

      # Tasks Service - Subscription based
      - name: tasks-service
        url: http://atlas-tasks.atlas.svc.cluster.local:8000
        routes:
          - name: tasks-routes
            paths:
              - /api/tasks
            strip_path: true
            preserve_host: true

      # CRM Service - Team+ plans
      - name: crm-service
        url: http://atlas-crm.atlas.svc.cluster.local:8000
        routes:
          - name: crm-routes
            paths:
              - /api/crm
            strip_path: true
            preserve_host: true

      # Invoicing Service - All plans
      - name: invoicing-service
        url: http://atlas-invoicing.atlas.svc.cluster.local:8000
        routes:
          - name: invoicing-routes
            paths:
              - /api/invoicing
            strip_path: true
            preserve_host: true

      # Marketing Service - Growth+ plans
      - name: marketing-service
        url: http://atlas-marketing.atlas.svc.cluster.local:8000
        routes:
          - name: marketing-routes
            paths:
              - /api/marketing
            strip_path: true
            preserve_host: true

      # Analytics Service - Scale+ plans
      - name: analytics-service
        url: http://atlas-analytics.atlas.svc.cluster.local:8000
        routes:
          - name: analytics-routes
            paths:
              - /api/analytics
            strip_path: true
            preserve_host: true

      # Communication Service - All plans
      - name: communication-service
        url: http://atlas-communication.atlas.svc.cluster.local:8000
        routes:
          - name: communication-routes
            paths:
              - /api/notifications
            strip_path: true
            preserve_host: true

      # File Service - All plans
      - name: file-service
        url: http://atlas-files.atlas.svc.cluster.local:8000
        routes:
          - name: file-routes
            paths:
              - /api/files
            strip_path: true
            preserve_host: true

      # Search Service - All plans
      - name: search-service
        url: http://atlas-search.atlas.svc.cluster.local:8000
        routes:
          - name: search-routes
            paths:
              - /api/search
            strip_path: true
            preserve_host: true

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: atlas
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
        - name: kong
          image: kong:3.4
          ports:
            - containerPort: 8000
            - containerPort: 8443
          env:
            - name: KONG_DATABASE
              value: "off"
            - name: KONG_DECLARATIVE_CONFIG
              value: "/etc/kong/kong.yml"
            - name: KONG_PROXY_ACCESS_LOG
              value: "/dev/stdout"
            - name: KONG_ADMIN_ACCESS_LOG
              value: "/dev/stdout"
            - name: KONG_PROXY_ERROR_LOG
              value: "/dev/stderr"
            - name: KONG_ADMIN_ERROR_LOG
              value: "/dev/stderr"
            - name: KONG_ADMIN_LISTEN
              value: "0.0.0.0:8001"
            - name: KONG_PROXY_LISTEN
              value: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
          volumeMounts:
            - name: kong-config
              mountPath: /etc/kong
          livenessProbe:
            httpGet:
              path: /status
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /status
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: kong-config
          configMap:
            name: api-gateway-config

---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: atlas
spec:
  selector:
    app: api-gateway
  ports:
    - name: http
      port: 80
      targetPort: 8000
    - name: https
      port: 443
      targetPort: 8443
  type: LoadBalancer
